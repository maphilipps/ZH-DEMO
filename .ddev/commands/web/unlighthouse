#!/bin/bash

## Description: Run Unlighthouse scanning for comprehensive mobile/desktop testing
## Usage: unlighthouse [options]
## Example: "ddev unlighthouse" - Full scan (mobile + desktop)
## Example: "ddev unlighthouse --demo-check" - Quick demo validation scan
## Example: "ddev unlighthouse --mobile" - Mobile-only scan
## Example: "ddev unlighthouse --desktop" - Desktop-only scan

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print with colors
print_info() { echo -e "${BLUE}ℹ️  $1${NC}"; }
print_success() { echo -e "${GREEN}✅ $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }

# Function to check if unlighthouse container is running
check_container() {
    if ! docker ps --filter "name=ddev-${DDEV_SITENAME}-unlighthouse" --format "{{.Names}}" | grep -q "ddev-${DDEV_SITENAME}-unlighthouse"; then
        print_error "Unlighthouse container is not running. Please run 'ddev start' first."
        exit 1
    fi
}

# Function to wait for site to be ready
wait_for_site() {
    local site_url="https://zh-demo.ddev.site"
    print_info "Waiting for site to be ready at ${site_url}..."
    
    local max_attempts=30
    local attempt=0
    
    while [ $attempt -lt $max_attempts ]; do
        if curl -s -k --max-time 5 "${site_url}" > /dev/null 2>&1; then
            print_success "Site is ready!"
            return 0
        fi
        
        attempt=$((attempt + 1))
        echo -n "."
        sleep 2
    done
    
    print_warning "Site might not be fully ready, but proceeding with scan..."
}

# Function to run unlighthouse scan
run_scan() {
    local device="$1"
    local samples="$2"
    local config_override=""
    
    case "$device" in
        "mobile")
            config_override="--scanner.device mobile"
            print_info "Running MOBILE-ONLY scan..."
            ;;
        "desktop")
            config_override="--scanner.device desktop"
            print_info "Running DESKTOP-ONLY scan..."
            ;;
        "demo")
            config_override="--scanner.samples 3 --scanner.device both"
            print_info "Running QUICK DEMO validation scan (3 samples)..."
            ;;
        "both"|*)
            config_override="--scanner.device both"
            print_info "Running FULL scan (mobile + desktop)..."
            ;;
    esac
    
    # Ensure reports directory exists
    mkdir -p /var/www/html/reports
    
    # Run the scan
    print_info "Starting Unlighthouse scan..."
    docker exec -it "ddev-${DDEV_SITENAME}-unlighthouse" sh -c "
        cd /app && 
        unlighthouse-cli \
            --site https://zh-demo.ddev.site \
            --config-file /app/unlighthouse.config.ts \
            --server.port 5678 \
            --server.host 0.0.0.0 \
            --outputPath /app/.unlighthouse \
            $config_override \
            --ci
    "
    
    if [ $? -eq 0 ]; then
        print_success "Scan completed successfully!"
        print_info "View results at: https://zh-demo.ddev.site:5678"
        print_info "Reports saved to: ./reports/unlighthouse/"
        
        # Swiss compliance validation
        print_info "🇨🇭 Checking Swiss compliance (WCAG 2.1 AA + eCH-0059)..."
        docker exec "ddev-${DDEV_SITENAME}-unlighthouse" sh -c "
            if [ -f /app/.unlighthouse/lighthouse-report.json ]; then
                echo 'Swiss Compliance Check Results:'
                echo '- WCAG 2.1 AA: Run accessibility audit for full compliance'
                echo '- eCH-0059: Check minimum 16px font sizes in results'
                echo '- Touch targets: Validate 44px minimum for mobile'
            fi
        "
    else
        print_error "Scan failed. Check the logs above for details."
        exit 1
    fi
}

# Function to show help
show_help() {
    echo ""
    echo "Unlighthouse - Comprehensive Mobile/Desktop Scanning"
    echo ""
    echo "Usage: ddev unlighthouse [options]"
    echo ""
    echo "Options:"
    echo "  (none)        Full scan (mobile + desktop) - Complete site analysis"
    echo "  --demo-check  Quick demo validation (3 samples, both devices)"
    echo "  --mobile      Mobile-only scan (375px viewport)"
    echo "  --desktop     Desktop-only scan (1200px viewport)"
    echo "  --help, -h    Show this help message"
    echo ""
    echo "Swiss Compliance Features:"
    echo "  ✓ WCAG 2.1 AA accessibility testing"
    echo "  ✓ eCH-0059 Swiss Government Standards"
    echo "  ✓ Minimum 16px font size validation"
    echo "  ✓ 44px touch target validation (mobile)"
    echo ""
    echo "Examples:"
    echo "  ddev unlighthouse                 # Full site scan"
    echo "  ddev unlighthouse --demo-check    # Quick validation for demo"
    echo "  ddev unlighthouse --mobile        # Mobile performance focus"
    echo ""
    echo "Results will be available at: https://zh-demo.ddev.site:5678"
    echo ""
}

# Main execution
case "$1" in
    "--help"|"-h"|"help")
        show_help
        exit 0
        ;;
    "--demo-check")
        check_container
        wait_for_site
        run_scan "demo"
        ;;
    "--mobile")
        check_container
        wait_for_site
        run_scan "mobile"
        ;;
    "--desktop")
        check_container
        wait_for_site
        run_scan "desktop"
        ;;
    "")
        check_container
        wait_for_site
        run_scan "both"
        ;;
    *)
        print_error "Unknown option: $1"
        show_help
        exit 1
        ;;
esac