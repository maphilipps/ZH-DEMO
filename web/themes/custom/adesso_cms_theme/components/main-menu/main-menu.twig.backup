{# Set variant-specific classes #}
{% set variant = variant|default('default') %}
{% set variant_classes = {
  'default': {
    'link_classes': 'text-sm/6 font-semibold text-gray-900 hover:text-primary',
    'button_classes': 'inline-flex items-center gap-x-1 text-sm/6 font-semibold text-gray-900',
    'mobile_button_classes': '-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-700',
    'mobile_link_classes': '-mx-3 block rounded-lg px-3 py-2 text-base/7 font-semibold text-gray-900 hover:bg-gray-50',
    'logo_variant': 'default'
  },
  'transparent': {
    'link_classes': 'text-sm/6 font-semibold text-white hover:text-gray-200',
    'button_classes': 'inline-flex items-center gap-x-1 text-sm/6 font-semibold text-white',
    'mobile_button_classes': '-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-white',
    'mobile_link_classes': '-mx-3 block rounded-lg px-3 py-2 text-base/7 font-semibold text-gray-900 hover:bg-gray-50',
    'logo_variant': 'inverted'
  }
} %}

{% set current_variant = variant_classes[variant] %}

{# Main Navigation Menu based on exact templates - no Alpine.js #}
<nav class="relative isolate z-50">
      <div class="max-lg:hidden lg:flex lg:items-center lg:gap-x-12">
        {% for item in nested %}
          {# Desktop menu items with children (popover) #}
          {% if item.children is not empty %}
            <div class="relative">
              {% if item.url is empty or item.url.toString() == '<nolink>' %}
                <button popovertarget="desktop-menu-{{ loop.index }}" class="{{ current_variant.button_classes }}">
                  {{ item.title }}
                  <svg viewBox="0 0 20 20" fill="currentColor" data-slot="icon" aria-hidden="true" class="size-5">
                    <path d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                  </svg>
                </button>
              {% else %}
                <a href="{{ item.url }}"{% if item.target %} target="{{ item.target }}"{% endif %} popovertarget="desktop-menu-{{ loop.index }}" class="{{ current_variant.button_classes }}">
                  {{ item.title }}
                  <svg viewBox="0 0 20 20" fill="currentColor" data-slot="icon" aria-hidden="true" class="size-5">
                    <path d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                  </svg>
                </a>
              {% endif %}

              {# Desktop Popover #}
              <el-popover id="desktop-menu-{{ loop.index }}" anchor="bottom" popover class="w-screen max-w-min overflow-visible bg-transparent px-4 transition transition-discrete [--anchor-gap:--spacing(5)] backdrop:bg-transparent open:flex data-closed:translate-y-1 data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-150 data-leave:ease-in">
                <div class="w-56 shrink rounded-xl bg-white p-4 text-sm/6 font-semibold text-gray-900 shadow-lg ring-1 ring-gray-900/5">
                  {% for child in item.children %}
                    {% if child.url is empty or child.url.toString() == '<nolink>' %}
                      <span class="block p-2 text-gray-500">{{ child.title }}</span>
                    {% else %}
                      <a href="{{ child.url }}"{% if child.target %} target="{{ child.target }}"{% endif %} class="block p-2 hover:text-primary">{{ child.title }}</a>
                    {% endif %}
                    
                    {# Nested children (third level) - indented #}
                    {% if child.children is not empty %}
                      {% for grandchild in child.children %}
                        {% if grandchild.url is empty or grandchild.url.toString() == '<nolink>' %}
                          <span class="block p-2 pl-6 text-xs text-gray-400">{{ grandchild.title }}</span>
                        {% else %}
                          <a href="{{ grandchild.url }}"{% if grandchild.target %} target="{{ grandchild.target }}"{% endif %} class="block p-2 pl-6 text-xs hover:text-primary">{{ grandchild.title }}</a>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </div>
              </el-popover>
            </div>
          {# Desktop menu items without children (simple links) #}
          {% else %}
            {% if item.url is empty or item.url.toString() == '<nolink>' %}
              <span class="{{ current_variant.link_classes }}">{{ item.title }}</span>
            {% else %}
              <a href="{{ item.url }}"{% if item.target %} target="{{ item.target }}"{% endif %} class="{{ current_variant.link_classes }}">{{ item.title }}</a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>

  {# Mobile Menu Toggle Button #}
  <div class="flex lg:hidden">
    <button type="button" command="show-modal" commandfor="mobile-menu" class="{{ current_variant.mobile_button_classes }}" aria-expanded="false">
      <span class="sr-only">{{ 'Open main menu'|t }}</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6">
        <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
    </button>
  </div>

  {# Mobile Menu Dialog #}
  <el-dialog>
    <dialog id="mobile-menu" class="backdrop:bg-transparent lg:hidden data-closed:translate-y-1 transition-all duration-300" style="right: var(--el-top-layer-scrollbar-offset, 0px);">
      <div tabindex="0" class="fixed inset-0 focus:outline-none">
        <el-dialog-panel class="fixed inset-y-0 right-0 z-50 w-full overflow-y-auto bg-white p-6 transition-all duration-200">
          <div class="flex items-center justify-between">
            <a href="{{ front_page|default('/') }}" class="-m-1.5 p-1.5">
              {% if show_logo and logo %}
                <span class="sr-only">{{ site_name|default('') }}</span>
                {% include 'adesso_cms_theme:logo' with {
                  site_logo: logo,
                  site_name: site_name,
                  variant: current_variant.logo_variant,
                  modifier: 'h-8 w-auto'
                } %}
              {% else %}
                <span class="text-lg font-bold text-gray-900">{{ site_name|default('adessoCMS') }}</span>
              {% endif %}
            </a>
            <button type="button" command="close" commandfor="mobile-menu" class="-m-2.5 rounded-md p-2.5 text-gray-700" aria-expanded="false">
              <span class="sr-only">{{ 'Close menu'|t }}</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6">
                <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </button>
          </div>
          <div class="mt-6 flow-root">
            <div class="-my-6 divide-y divide-gray-500/10">
              <div class="space-y-2 py-6">
                {% for item in nested %}
                  {% if item.url is empty or item.url.toString() == '<nolink>' %}
                    <span class="{{ current_variant.mobile_link_classes }}">{{ item.title }}</span>
                  {% else %>
                    <a href="{{ item.url }}"{% if item.target %} target="{{ item.target }}"{% endif %} class="{{ current_variant.mobile_link_classes }}">{{ item.title }}</a>
                  {% endif %}

                  {# Mobile Submenu #}
                  {% if item.children is not empty %}
                    <div class="ml-6 space-y-1">
                      {% for child in item.children %}
                        {% if child.url is empty or child.url.toString() == '<nolink>' %}
                          <span class="-mx-3 block rounded-lg px-3 py-1 text-sm/6 text-gray-600">{{ child.title }}</span>
                        {% else %}
                          <a href="{{ child.url }}"{% if child.target %} target="{{ child.target }}"{% endif %} class="-mx-3 block rounded-lg px-3 py-1 text-sm/6 text-gray-600 hover:bg-gray-50">{{ child.title }}</a>
                        {% endif %}

                        {# Mobile nested children (third level) #}
                        {% if child.children is not empty %}
                          <div class="ml-4 space-y-1">
                            {{ _self.render_mobile_submenu(child.children) }}
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
        </el-dialog-panel>
      </div>
    </dialog>
  </el-dialog>
</nav>

{# Macro for desktop popover submenu rendering #}
{% macro render_submenu(children) %}
  {% for child in children %}
    {% if child.url is empty or child.url.toString() == '<nolink>' %}
      <span class="flex gap-x-4 py-1 text-xs/5 text-gray-600">
        {{ _self.get_menu_icon(child.title, 'size-4') }}
        {{ child.title }}
      </span>
    {% else %}
      <a href="{{ child.url }}"{% if child.target %} target="{{ child.target }}"{% endif %} class="flex gap-x-4 py-1 text-xs/5 text-gray-600 hover:text-gray-900">
        {{ _self.get_menu_icon(child.title, 'size-4') }}
        {{ child.title }}
      </a>
    {% endif %}
  {% endfor %}
{% endmacro %}

{# Macro for mobile submenu rendering #}
{% macro render_mobile_submenu(children) %}
  {% for child in children %}
    {% if child.url is empty or child.url.toString() == '<nolink>' %}
      <span class="-mx-3 block rounded-lg px-3 py-1 text-xs/5 text-gray-500">{{ child.title }}</span>
    {% else %}
      <a href="{{ child.url }}"{% if child.target %} target="{{ child.target }}"{% endif %} class="-mx-3 block rounded-lg px-3 py-1 text-xs/5 text-gray-500 hover:bg-gray-50">{{ child.title }}</a>
    {% endif %}
  {% endfor %}
{% endmacro %}

{# Simplified macro for icon mapping #}
{% macro get_menu_icon(title, size_class = 'size-6') %}
  {% set icon_class = 'flex-none text-gray-400 ' ~ size_class %}
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="{{ icon_class }}">
    <path d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" stroke-linecap="round" stroke-linejoin="round" />
  </svg>
{% endmacro %}