# adesso CMS Production-Ready DDEV Configuration
# ADE-98: Optimized for team scalability and production readiness
# "adesso wird immer klein geschrieben" - brand compliance

# Performance optimizations for large development teams
performance_mode: "global"
default_container_timeout: 300  # Extended timeout for complex builds

# Enhanced security and monitoring
web_environment:
    - VITE_DEV_SERVER_HOST=0.0.0.0
    - VITE_DEV_SERVER_PORT=5173
    - NODE_OPTIONS=--max-old-space-size=4096  # Increased memory for Vite builds
    - ADESSO_BRAND_LOWERCASE=true
    - DRUPAL_ENVIRONMENT=development
    - VITE_HMR_TIMEOUT=60000
    - STORYBOOK_TELEMETRY_URL=""  # Disable telemetry for privacy

# Resource management for container optimization
web_extra_daemons:
    - name: vite-health-check
      command: "while true; do if ! curl -f -k https://localhost:5173 >/dev/null 2>&1; then echo \"$(date): Vite dev server not responding on port 5173\"; fi; sleep 30; done"
      directory: /var/www/html
    - name: node-memory-monitor  
      command: "while true; do ps aux | grep node | grep -v grep | awk '{print $6}' | sort -n | tail -1 > /tmp/node_memory_peak; sleep 60; done"
      directory: /var/www/html

# Enhanced post-start hooks with validation
hooks:
    post-start:
        - exec: echo "================================================================================="
        - exec: echo "                            adesso CMS READY"
        - exec: echo "================================================================================="
        - exec: echo "Production-ready DDEV environment initialized"
        - exec: echo "Brand compliance: adesso wird immer klein geschrieben ✓"
        - exec: echo ""
        - exec: echo "Development Commands:"
        - exec: echo "  ddev theme dev     # Vite dev server (https://adesso-cms.ddev.site:5173)"
        - exec: echo "  ddev theme build   # Production build with optimization"
        - exec: echo "  ddev theme storybook # Component documentation (https://adesso-cms.ddev.site:6006)"
        - exec: echo ""
        - exec: echo "Quality Assurance:"
        - exec: echo "  ddev theme qa:full # Complete QA pipeline"
        - exec: echo "  ddev theme test    # Unit tests with Vitest"
        - exec: echo "  ddev theme visual:test # Visual regression testing"
        - exec: echo ""
        - exec: echo "Health Checks:"
        - exec: curl -f -k -s https://localhost/core/misc/favicon.ico > /dev/null && echo "✓ Drupal core accessible" || echo "✗ Drupal core not accessible"
        - exec: test -f /var/www/html/web/themes/custom/adesso_cms_theme/package.json && echo "✓ Theme package.json present" || echo "✗ Theme package.json missing"
        - exec: echo "================================================================================="
    pre-stop:
        - exec: echo "Cleaning up adesso CMS development environment..."
        - exec: pkill -f "vite" || true
        - exec: pkill -f "storybook" || true
        - exec: echo "Environment cleanup completed"

# Advanced networking for team environments
additional_fqdns: []  # Can be extended for team-specific domains
bind_all_interfaces: false  # Security: localhost only
use_dns_when_possible: true

# Development tool configurations
webimage_extra_packages: 
    - xdg-utils
    - pkg-config  
    - libpixman-1-dev
    - libcairo2-dev
    - libpango1.0-dev
    - make
    - curl
    - procps  # For process monitoring
    - htop    # For resource monitoring

# Override config to ensure production settings take precedence
override_config: true