{#
/**
 * @file
 * Foundation Link Component Template
 * 
 * A comprehensive, accessible link component for municipal portals.
 * Meets WCAG 2.1 AA accessibility standards and Swiss government compliance.
 *
 * Variables:
 * - text: The visible link text (required)
 * - url: The destination URL or URI (required)
 * - variant: Visual style variant (default|button|external|download|phone|email|inline)
 * - size: Size variant (sm|default|lg)
 * - title: Optional title attribute
 * - target: Link target attribute
 * - download: Download attribute for file links
 * - rel: Link relationship attributes
 * - aria_label: Custom ARIA label
 * - show_external_indicator: Show external link indicator (boolean)
 * - municipality_compliant: Enable municipal compliance features (boolean)
 * - modifier: Additional CSS classes
 * 
 * Slots:
 * - icon: Optional icon content
 * - badge: Optional badge content
 * - external_indicator: Custom external indicator
 */
#}

{# Determine if this is an external link #}
{% set is_external = url|default('') starts with 'http' and not (url|default('') starts with 'https://zh-demo.ddev.site' or url|default('') starts with '/') %}

{# Determine link type from URL or variant #}
{% set is_email = variant|default('') == 'email' or url|default('') starts with 'mailto:' %}
{% set is_phone = variant|default('') == 'phone' or url|default('') starts with 'tel:' %}
{% set is_download = variant|default('') == 'download' or download|default(false) %}

{# Build classes #}
{% set link_classes = [
  'adesso-link',
  'inline-flex',
  'items-center',
  'gap-2',
  'transition-colors',
  'duration-200',
  'focus-visible:outline-none',
  'focus-visible:ring-2',
  'focus-visible:ring-blue-500',
  'focus-visible:ring-offset-2',
  'focus-visible:ring-offset-white',
  'rounded-sm'
] %}

{# Variant-specific classes #}
{% if variant|default('') == 'button' %}
  {% set link_classes = link_classes|merge([
    'inline-flex',
    'rounded-lg',
    'justify-center',
    'whitespace-nowrap',
    'font-medium',
    'shadow-sm',
    'border',
    'border-transparent',
    'bg-blue-600',
    'text-white',
    'hover:bg-blue-700',
    'active:bg-blue-800',
    'disabled:opacity-50',
    'disabled:pointer-events-none'
  ]) %}
{% elseif variant|default('') == 'external' or is_external %}
  {% set link_classes = link_classes|merge([
    'text-blue-600',
    'hover:text-blue-800',
    'underline',
    'underline-offset-4',
    'decoration-1',
    'hover:decoration-2'
  ]) %}
{% elseif variant|default('') == 'download' or is_download %}
  {% set link_classes = link_classes|merge([
    'text-green-600',
    'hover:text-green-800',
    'underline',
    'underline-offset-4',
    'decoration-1',
    'hover:decoration-2'
  ]) %}
{% elseif variant|default('') == 'phone' or is_phone %}
  {% set link_classes = link_classes|merge([
    'text-blue-600',
    'hover:text-blue-800',
    'no-underline',
    'hover:underline',
    'underline-offset-4'
  ]) %}
{% elseif variant|default('') == 'email' or is_email %}
  {% set link_classes = link_classes|merge([
    'text-blue-600',
    'hover:text-blue-800',
    'no-underline',
    'hover:underline',
    'underline-offset-4'
  ]) %}
{% elseif variant|default('') == 'inline' %}
  {% set link_classes = link_classes|merge([
    'text-blue-600',
    'hover:text-blue-800',
    'underline',
    'underline-offset-2',
    'decoration-1'
  ]) %}
{% else %}
  {# Default variant #}
  {% set link_classes = link_classes|merge([
    'text-blue-600',
    'hover:text-blue-800',
    'underline',
    'underline-offset-4',
    'decoration-1',
    'hover:decoration-2'
  ]) %}
{% endif %}

{# Size-specific classes #}
{% if size|default('') == 'sm' %}
  {% set link_classes = link_classes|merge([
    'text-sm',
    variant|default('') == 'button' ? 'px-3 py-1.5 h-8' : ''
  ])|filter %}
{% elseif size|default('') == 'lg' %}
  {% set link_classes = link_classes|merge([
    'text-lg',
    variant|default('') == 'button' ? 'px-6 py-3 h-12' : ''
  ])|filter %}
{% else %}
  {# Default size #}
  {% set link_classes = link_classes|merge([
    'text-base',
    variant|default('') == 'button' ? 'px-4 py-2 h-9' : ''
  ])|filter %}
{% endif %}

{# Add modifier classes #}
{% if modifier|default('') %}
  {% set link_classes = link_classes|merge([modifier]) %}
{% endif %}

{# Build attributes with proper escaping #}
{% set link_attributes = {
  'href': url|default('')|escape('html_attr'),
  'class': link_classes|join(' ')|escape('html_attr')
} %}

{# Add title attribute if provided #}
{% if title|default('') %}
  {% set link_attributes = link_attributes|merge({'title': title|escape('html_attr')}) %}
{% endif %}

{# Add ARIA label if provided #}
{% if aria_label|default('') %}
  {% set link_attributes = link_attributes|merge({'aria-label': aria_label|escape('html_attr')}) %}
{% endif %}

{# Handle target attribute and security for external links #}
{% if target|default('') %}
  {% set link_attributes = link_attributes|merge({'target': target}) %}
{% elseif is_external %}
  {% set link_attributes = link_attributes|merge({'target': '_blank'}) %}
{% endif %}

{# Add security attributes for external links with proper escaping #}
{% if is_external or target|default('') == '_blank' %}
  {% set security_rel = rel|default('') ? rel ~ ' noopener noreferrer' : 'noopener noreferrer' %}
  {% set link_attributes = link_attributes|merge({'rel': security_rel|escape('html_attr')}) %}
{% elseif rel|default('') %}
  {% set link_attributes = link_attributes|merge({'rel': rel|escape('html_attr')}) %}
{% endif %}

{# Add download attribute with proper escaping #}
{% if download|default(false) %}
  {% if download is same as(true) %}
    {% set link_attributes = link_attributes|merge({'download': ''}) %}
  {% else %}
    {% set link_attributes = link_attributes|merge({'download': download|escape('html_attr')}) %}
  {% endif %}
{% endif %}

{# Add data attributes for JavaScript enhancement with proper escaping #}
{% set link_attributes = link_attributes|merge({
  'data-adesso-link': 'true',
  'data-variant': variant|default('default')|escape('html_attr'),
  'data-external': is_external ? 'true' : 'false',
  'data-municipality-compliant': municipality_compliant|default(true) ? 'true' : 'false'
}) %}

{# Render the link #}
<a{{ attributes(link_attributes) }}>
  {# Icon slot (before text) #}
  {% if icon|default('') %}
    <span class="adesso-link__icon" aria-hidden="true">
      {{ icon }}
    </span>
  {% endif %}

  {# Default icons based on link type #}
  {% if not icon|default('') %}
    {% if is_phone %}
      <span class="adesso-link__icon" aria-hidden="true">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
        </svg>
      </span>
    {% elseif is_email %}
      <span class="adesso-link__icon" aria-hidden="true">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
      </span>
    {% elseif is_download %}
      <span class="adesso-link__icon" aria-hidden="true">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
      </span>
    {% endif %}
  {% endif %}

  {# Link text with XSS protection #}
  <span class="adesso-link__text">{{ text|default('')|escape }}</span>

  {# Badge slot #}
  {% if badge|default('') %}
    <span class="adesso-link__badge">
      {{ badge }}
    </span>
  {% endif %}

  {# External link indicator #}
  {% if is_external and show_external_indicator|default(true) %}
    {% if external_indicator|default('') %}
      {{ external_indicator }}
    {% else %}
      <span class="adesso-link__external-indicator" aria-hidden="true">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      </span>
      <span class="sr-only">{{ 'Opens in new window'|t }}</span>
    {% endif %}
  {% endif %}
</a>