{# Set up responsive layout and variant classes #}
{% set layout = layout|default('horizontal') %}
{% set variant = variant|default('default') %}
{% set responsive_breakpoint = responsive_breakpoint|default('lg') %}
{% set show_mobile_toggle = show_mobile_toggle ?? true %}

{# Layout-specific wrapper classes #}
{% set layout_classes = {
  'horizontal': 'c-main-menu--horizontal',
  'vertical': 'c-main-menu--vertical', 
  'mobile': 'c-main-menu--mobile'
} %}

{# Responsive classes for mobile toggle visibility #}
{% set responsive_classes = {
  'sm': 'flex sm:hidden',
  'md': 'flex md:hidden',
  'lg': 'flex lg:hidden',
  'xl': 'flex xl:hidden'
} %}

{% set desktop_classes = {
  'sm': 'max-sm:hidden sm:flex',
  'md': 'max-md:hidden md:flex', 
  'lg': 'max-lg:hidden lg:flex',
  'xl': 'max-xl:hidden xl:flex'
} %}

{# Variant-specific classes for theming #}
{% set variant_classes = {
  'default': {
    'mobile_button_classes': '-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-700',
    'logo_variant': 'default'
  },
  'transparent': {
    'mobile_button_classes': '-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-white',
    'logo_variant': 'inverted'
  }
} %}

{% set current_variant = variant_classes[variant] %}

{# Main Navigation Menu - Unified Architecture #}
<nav class="c-main-menu relative isolate z-50 {{ layout_classes[layout] }}" 
     {% if aria_label %}aria-label="{{ aria_label }}"{% endif %}
     role="navigation">
     
  {% if show_logo and (layout == 'mobile' or layout == 'horizontal') %}
    {# Logo Section - for header integration #}
    <div class="flex {{ responsive_breakpoint }}:flex-1">
      <a href="{{ front_page|default('/') }}" class="-m-1.5 p-1.5" aria-label="{{ site_name }}">
        {% if logo %}
          <span class="sr-only">{{ site_name }}</span>
          {% include 'adesso_cms_theme:logo' with {
            site_logo: logo,
            site_name: site_name,
            variant: current_variant.logo_variant,
            modifier: 'h-8 w-auto'
          } %}
        {% else %}
          <span class="text-lg font-bold text-gray-900">{{ site_name }}</span>
        {% endif %}
      </a>
    </div>
  {% endif %}

  {# Desktop Menu Items #}
  <div class="{{ desktop_classes[responsive_breakpoint] }} {{ responsive_breakpoint }}:items-center {{ responsive_breakpoint }}:gap-x-12">
    {% for item in nested %}
      {% if item.children is not empty %}
        {# Menu item with children - using el-popover #}
        <div class="relative">
          {% include 'adesso_cms_theme:menu-item' with {
            title: item.title,
            url: item.url,
            target: item.target,
            is_active: item.is_active,
            in_active_trail: item.in_active_trail,
            has_children: true,
            variant: 'desktop',
            theme: variant,
            level: 0
          } only %}

          {# Desktop Popover using existing el-popover pattern #}
          <el-popover id="desktop-menu-{{ loop.index }}" anchor="bottom" popover
                      class="w-screen max-w-min overflow-visible bg-transparent px-4 transition transition-discrete [--anchor-gap:--spacing(5)] backdrop:bg-transparent open:flex data-closed:translate-y-1 data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-150 data-leave:ease-in">
            <div class="max-w-xl w-screen grid grid-flow-row grid-cols-1 lg:grid-cols-3 gap-4 shrink rounded-xl bg-white p-4 text-md/6 font-semibold text-gray-900 shadow-lg ring-1 ring-gray-900/5">
              {% for child in item.children %}
                <div>
                  {% include 'adesso_cms_theme:menu-item' with {
                    title: child.title,
                    url: child.url,
                    target: child.target,
                    is_active: child.is_active,
                    in_active_trail: child.in_active_trail,
                    has_children: child.children is not empty,
                    variant: 'dropdown',
                    theme: variant,
                    level: 1
                  } only %}

                  {# Third level items - nested children #}
                  {% if child.children is not empty %}
                    {% for grandchild in child.children %}
                      {% include 'adesso_cms_theme:menu-item' with {
                        title: grandchild.title,
                        url: grandchild.url,
                        target: grandchild.target,
                        is_active: grandchild.is_active,
                        in_active_trail: grandchild.in_active_trail,
                        has_children: false,
                        variant: 'dropdown',
                        theme: variant,
                        level: 2
                      } only %}
                    {% endfor %}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </el-popover>
        </div>
      {% else %}
        {# Simple menu item without children #}
        {% include 'adesso_cms_theme:menu-item' with {
          title: item.title,
          url: item.url,
          target: item.target,
          is_active: item.is_active,
          in_active_trail: item.in_active_trail,
          has_children: false,
          variant: 'desktop',
          theme: variant,
          level: 0
        } only %}
      {% endif %}
    {% endfor %}
  </div>

  {% if show_mobile_toggle %}
    {# Mobile Menu Toggle Button #}
    <div class="{{ responsive_classes[responsive_breakpoint] }}">
      <button type="button" command="show-modal" commandfor="mobile-menu"
              class="{{ current_variant.mobile_button_classes }}" aria-expanded="false">
        <span class="sr-only">{{ 'Open main menu'|t }}</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true"
             class="size-6">
          <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </button>
    </div>

    {# Mobile Menu Dialog #}
    <el-dialog>
      <dialog id="mobile-menu"
              class="backdrop:bg-transparent {{ responsive_breakpoint }}:hidden data-closed:translate-y-1 transition-all duration-300"
              style="right: var(--el-top-layer-scrollbar-offset, 0px);">
        <div tabindex="0" class="fixed inset-0 focus:outline-none">
          <el-dialog-panel
                  class="fixed inset-y-0 right-0 z-50 w-full overflow-y-auto bg-white p-6 transition-all duration-200">
            <div class="flex items-center justify-between">
              <a href="{{ front_page|default('/') }}" class="-m-1.5 p-1.5">
                <span class="sr-only">{{ site_name|default('') }}</span>
                {% if logo %}
                  {% include 'adesso_cms_theme:logo' with {
                    site_logo: logo,
                    site_name: site_name,
                    variant: current_variant.logo_variant,
                    modifier: 'h-8 w-auto'
                  } %}
                {% else %}
                  <span class="text-lg font-bold text-gray-900">{{ site_name }}</span>
                {% endif %}
              </a>
              <button type="button" command="close" commandfor="mobile-menu" class="-m-2.5 rounded-md p-2.5 text-gray-700"
                      aria-expanded="false">
                <span class="sr-only">{{ 'Close menu'|t }}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon"
                     aria-hidden="true" class="size-6">
                  <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </button>
            </div>
            <div class="mt-6 flow-root">
              <div class="-my-6 divide-y divide-gray-500/10">
                <div class="space-y-2 py-6">
                  {% for item in nested %}
                    {% include 'adesso_cms_theme:menu-item' with {
                      title: item.title,
                      url: item.url,
                      target: item.target,
                      is_active: item.is_active,
                      in_active_trail: item.in_active_trail,
                      has_children: false,
                      variant: 'mobile',
                      theme: variant,
                      level: 0
                    } only %}

                    {# Mobile Submenu - using menu-item components #}
                    {% if item.children is not empty %}
                      <div class="ml-6 space-y-1">
                        {% for child in item.children %}
                          {% include 'adesso_cms_theme:menu-item' with {
                            title: child.title,
                            url: child.url,
                            target: child.target,
                            is_active: child.is_active,
                            in_active_trail: child.in_active_trail,
                            has_children: false,
                            variant: 'mobile',
                            theme: variant,
                            level: 1
                          } only %}

                          {# Mobile nested children (third level) #}
                          {% if child.children is not empty %}
                            <div class="ml-4 space-y-1">
                              {% for grandchild in child.children %}
                                {% include 'adesso_cms_theme:menu-item' with {
                                  title: grandchild.title,
                                  url: grandchild.url,
                                  target: grandchild.target,
                                  is_active: grandchild.is_active,
                                  in_active_trail: grandchild.in_active_trail,
                                  has_children: false,
                                  variant: 'mobile',
                                  theme: variant,
                                  level: 2
                                } only %}
                              {% endfor %}
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </el-dialog-panel>
        </div>
      </dialog>
    </el-dialog>
  {% endif %}
</nav>

{# 
  Legacy macro kept for compatibility but deprecated
  Icons should now be passed through the icon slot of menu-item components
  This macro may be removed in future versions
#}