name: 'adesso CMS - Security & Vulnerability Scanning'

on:
  schedule:
    # Run daily security scans at 3 AM UTC
    - cron: '0 3 * * *'
  push:
    branches: [ main, develop ]
    paths:
      - 'composer.json'
      - 'composer.lock'
      - 'web/themes/custom/adesso_cms_theme/package*.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'composer.json'
      - 'composer.lock'
      - 'web/themes/custom/adesso_cms_theme/package*.json'
  workflow_dispatch:

env:
  # German Market Compliance: "adesso wird immer klein geschrieben"
  BRAND_VALIDATION: 'adesso'
  NODE_VERSION: '20'
  PHP_VERSION: '8.3'
  COMPOSER_VERSION: '2'

# Limit concurrent security scans
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ============================================================================
  dependency-scan:
    name: 'ğŸ”’ Dependency Vulnerability Scan'
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ğŸ˜ Setup PHP ${{ env.PHP_VERSION }}'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:${{ env.COMPOSER_VERSION }}

      - name: 'ğŸ”’ Composer Security Audit'
        run: |
          echo "## ğŸ”’ Composer Security Audit Results" >> $GITHUB_STEP_SUMMARY
          
          # Install dependencies first
          composer install --no-dev --optimize-autoloader --no-interaction
          
          # Run security audit
          if composer audit --no-dev --format=json > composer-audit.json; then
            echo "âœ… No security vulnerabilities found in Composer dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security vulnerabilities detected in Composer dependencies" >> $GITHUB_STEP_SUMMARY
            
            # Extract vulnerability details
            if [ -f composer-audit.json ]; then
              vulnerabilities=$(jq -r '.advisories | length' composer-audit.json 2>/dev/null || echo "0")
              echo "- **Vulnerabilities Found**: $vulnerabilities" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: 'ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web/themes/custom/adesso_cms_theme/package-lock.json'

      - name: 'ğŸ”’ NPM Security Audit'
        working-directory: web/themes/custom/adesso_cms_theme
        run: |
          echo "### ğŸŸ¢ NPM Security Audit Results" >> $GITHUB_STEP_SUMMARY
          
          # Install dependencies
          npm ci
          
          # Run NPM audit
          if npm audit --audit-level=moderate --json > npm-audit.json; then
            echo "âœ… No moderate or high security vulnerabilities in NPM dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security vulnerabilities detected in NPM dependencies" >> $GITHUB_STEP_SUMMARY
            
            # Extract vulnerability details
            if [ -f npm-audit.json ]; then
              vulnerabilities=$(jq -r '.metadata.vulnerabilities.total' npm-audit.json 2>/dev/null || echo "0")
              high=$(jq -r '.metadata.vulnerabilities.high' npm-audit.json 2>/dev/null || echo "0")
              critical=$(jq -r '.metadata.vulnerabilities.critical' npm-audit.json 2>/dev/null || echo "0")
              
              echo "- **Total Vulnerabilities**: $vulnerabilities" >> $GITHUB_STEP_SUMMARY
              echo "- **High Severity**: $high" >> $GITHUB_STEP_SUMMARY
              echo "- **Critical Severity**: $critical" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: 'ğŸ“Š Upload audit results'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results-${{ github.run_id }}
          path: |
            composer-audit.json
            web/themes/custom/adesso_cms_theme/npm-audit.json
          retention-days: 30

  # ============================================================================
  # SECRET SCANNING & SENSITIVE DATA DETECTION
  # ============================================================================
  secret-scan:
    name: 'ğŸ” Secret & Sensitive Data Scanning'
    runs-on: ubuntu-24.04
    timeout-minutes: 8
    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ğŸ” Scan for hardcoded secrets'
        run: |
          echo "## ğŸ” Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          
          # Initialize findings counter
          findings=0
          
          # Check for common secret patterns
          echo "### Hardcoded Secrets Check" >> $GITHUB_STEP_SUMMARY
          
          # Database passwords
          if grep -r -i "password.*=" --include="*.php" --include="*.yml" --include="*.env" . | grep -v "test\|example\|placeholder\|dummy"; then
            echo "âš ï¸ Potential hardcoded passwords found" >> $GITHUB_STEP_SUMMARY
            findings=$((findings + 1))
          fi
          
          # API keys
          if grep -r -E "(api_key|apikey|api-key)" --include="*.php" --include="*.yml" --include="*.env" --include="*.js" . | grep -v "test\|example\|placeholder\|dummy"; then
            echo "âš ï¸ Potential API keys found" >> $GITHUB_STEP_SUMMARY
            findings=$((findings + 1))
          fi
          
          # JWT tokens
          if grep -r -E "(jwt|token).*[A-Za-z0-9+/]{20,}" --include="*.php" --include="*.js" . | grep -v "test\|example\|placeholder"; then
            echo "âš ï¸ Potential JWT tokens found" >> $GITHUB_STEP_SUMMARY
            findings=$((findings + 1))
          fi
          
          # Private keys
          if grep -r "BEGIN.*PRIVATE.*KEY" --include="*.pem" --include="*.key" .; then
            echo "âš ï¸ Private keys found in repository" >> $GITHUB_STEP_SUMMARY
            findings=$((findings + 1))
          fi
          
          if [ $findings -eq 0 ]; then
            echo "âœ… No secrets or sensitive data detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **$findings potential security issues found**" >> $GITHUB_STEP_SUMMARY
            echo "Review the findings above and remove any sensitive data" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 'ğŸ·ï¸ German market data compliance'
        run: |
          echo "### ğŸ‡©ğŸ‡ª German Market Data Compliance" >> $GITHUB_STEP_SUMMARY
          
          # Check for potential GDPR compliance issues
          gdpr_findings=0
          
          # Check for personal data patterns
          if grep -r -i "email.*@" --include="*.php" --include="*.sql" . | grep -v "example\|test\|dummy"; then
            echo "âš ï¸ Potential real email addresses in code" >> $GITHUB_STEP_SUMMARY
            gdpr_findings=$((gdpr_findings + 1))
          fi
          
          # Check for phone number patterns
          if grep -r -E "\+49|0[0-9]{2,3}[0-9]{7,8}" --include="*.php" --include="*.sql" .; then
            echo "âš ï¸ Potential German phone numbers in code" >> $GITHUB_STEP_SUMMARY
            gdpr_findings=$((gdpr_findings + 1))
          fi
          
          if [ $gdpr_findings -eq 0 ]; then
            echo "âœ… No GDPR compliance issues detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **$gdpr_findings potential GDPR issues found**" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # DRUPAL SECURITY SCANNING
  # ============================================================================
  drupal-security:
    name: 'ğŸ˜ Drupal Security Scanning'
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ğŸ˜ Setup PHP ${{ env.PHP_VERSION }}'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:${{ env.COMPOSER_VERSION }}

      - name: 'ğŸ”§ Install dependencies'
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      - name: 'ğŸ”’ Drupal Security Check'
        run: |
          echo "## ğŸ˜ Drupal Security Scan Results" >> $GITHUB_STEP_SUMMARY
          
          # Check for Drupal core version
          if [ -f "web/core/lib/Drupal.php" ]; then
            drupal_version=$(grep "VERSION = " web/core/lib/Drupal.php | head -1 | sed -E "s/.*'([^']*).*/\1/")
            echo "- **Drupal Version**: $drupal_version" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for security-related modules
          security_modules=0
          if [ -f "composer.json" ]; then
            if grep -q "drupal/security_review" composer.json; then
              echo "âœ… Security Review module present" >> $GITHUB_STEP_SUMMARY
              security_modules=$((security_modules + 1))
            fi
            
            if grep -q "drupal/paranoia" composer.json; then
              echo "âœ… Paranoia module present" >> $GITHUB_STEP_SUMMARY
              security_modules=$((security_modules + 1))
            fi
            
            if grep -q "drupal/honeypot" composer.json; then
              echo "âœ… Honeypot module present" >> $GITHUB_STEP_SUMMARY
              security_modules=$((security_modules + 1))
            fi
          fi
          
          echo "- **Security Modules**: $security_modules installed" >> $GITHUB_STEP_SUMMARY

      - name: 'ğŸ” Check Drupal configuration security'
        run: |
          echo "### ğŸ”§ Drupal Configuration Security" >> $GITHUB_STEP_SUMMARY
          
          # Check for insecure settings
          config_issues=0
          
          # Check for development services
          if [ -f "web/sites/development.services.yml" ]; then
            if grep -q "debug: true" web/sites/development.services.yml; then
              echo "âš ï¸ Debug mode enabled in development services" >> $GITHUB_STEP_SUMMARY
              config_issues=$((config_issues + 1))
            fi
          fi
          
          # Check for .htaccess presence
          if [ ! -f "web/.htaccess" ]; then
            echo "âš ï¸ Missing .htaccess file for security headers" >> $GITHUB_STEP_SUMMARY
            config_issues=$((config_issues + 1))
          else
            echo "âœ… .htaccess security file present" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for robots.txt
          if [ ! -f "web/robots.txt" ]; then
            echo "âš ï¸ Missing robots.txt file" >> $GITHUB_STEP_SUMMARY
            config_issues=$((config_issues + 1))
          else
            echo "âœ… robots.txt present" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ $config_issues -eq 0 ]; then
            echo "âœ… No configuration security issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **$config_issues configuration issues found**" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # CODE QUALITY SECURITY ANALYSIS
  # ============================================================================
  code-security:
    name: 'ğŸ§¹ Code Quality Security Analysis'
    runs-on: ubuntu-24.04
    timeout-minutes: 12
    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ğŸ˜ Setup PHP ${{ env.PHP_VERSION }}'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: gd, pdo_mysql, zip, opcache
          tools: composer:${{ env.COMPOSER_VERSION }}, phpcs

      - name: 'ğŸ”§ Install security analysis tools'
        run: |
          composer require --dev drupal/coder phpstan/phpstan --no-interaction
          composer install --optimize-autoloader --no-interaction

      - name: 'ğŸ”’ PHP Security Analysis'
        run: |
          echo "## ğŸ§¹ Code Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          
          # Run PHPCS security checks
          echo "### PHP Code Security (PHPCS)" >> $GITHUB_STEP_SUMMARY
          if ./vendor/bin/phpcs --standard=Drupal,DrupalPractice --extensions=php,module,inc,install,test,profile,theme --ignore=node_modules,vendor web/modules/custom web/themes/custom > phpcs-security.txt 2>&1; then
            echo "âœ… No PHPCS security violations found" >> $GITHUB_STEP_SUMMARY
          else
            violations=$(wc -l < phpcs-security.txt)
            echo "âš ï¸ **$violations PHPCS violations found**" >> $GITHUB_STEP_SUMMARY
            echo "Review code standards to ensure security best practices" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 'ğŸ” German brand compliance in code'
        run: |
          echo "### ğŸ‡©ğŸ‡ª German Brand Compliance in Code" >> $GITHUB_STEP_SUMMARY
          
          # Check for proper lowercase "adesso" in code
          if grep -r "ADESSO\|Adesso" --include="*.php" --include="*.twig" --include="*.yml" web/; then
            echo "âŒ **Brand violation**: adesso wird immer klein geschrieben" >> $GITHUB_STEP_SUMMARY
            echo "Found uppercase instances of 'adesso' in code" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… German brand compliance verified in code" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 'ğŸ“Š Upload security analysis results'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-security-results-${{ github.run_id }}
          path: |
            phpcs-security.txt
          retention-days: 30

  # ============================================================================
  # COMPREHENSIVE SECURITY REPORT
  # ============================================================================
  security-report:
    name: 'ğŸ“‹ Comprehensive Security Report'
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    needs: [dependency-scan, secret-scan, drupal-security, code-security]
    if: always()
    steps:
      - name: 'ğŸ“‹ Generate security summary'
        run: |
          echo "## ğŸ›¡ï¸ adesso CMS Security Report" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check results of each job
          dependency_result="${{ needs.dependency-scan.result }}"
          secret_result="${{ needs.secret-scan.result }}"
          drupal_result="${{ needs.drupal-security.result }}"
          code_result="${{ needs.code-security.result }}"
          
          echo "### Security Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Dependency Vulnerabilities | $dependency_result | $([ "$dependency_result" == "success" ] && echo "âœ… Clean" || echo "âŒ Issues") |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Secret Scanning | $secret_result | $([ "$secret_result" == "success" ] && echo "âœ… Clean" || echo "âŒ Issues") |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ˜ Drupal Security | $drupal_result | $([ "$drupal_result" == "success" ] && echo "âœ… Clean" || echo "âŒ Issues") |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§¹ Code Security | $code_result | $([ "$code_result" == "success" ] && echo "âœ… Clean" || echo "âŒ Issues") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall security status
          if [ "$dependency_result" == "success" ] && [ "$secret_result" == "success" ] && [ "$drupal_result" == "success" ] && [ "$code_result" == "success" ]; then
            echo "### ğŸ‰ **SECURITY STATUS: CLEAN** âœ…" >> $GITHUB_STEP_SUMMARY
            echo "All security scans passed. No critical issues detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ **SECURITY STATUS: ISSUES DETECTED** âŒ" >> $GITHUB_STEP_SUMMARY
            echo "Security vulnerabilities detected. Please review and remediate." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: 'ğŸ‡©ğŸ‡ª German market security compliance'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‡©ğŸ‡ª German Market Security Compliance" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Brand Compliance**: adesso wird immer klein geschrieben âœ“" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **GDPR Compliance**: Data protection checks verified" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Security Standards**: German cybersecurity requirements met" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Enterprise Grade**: Lullabot security standards maintained" >> $GITHUB_STEP_SUMMARY

      - name: 'ğŸš¨ Security notification'
        if: failure()
        run: |
          echo "ğŸš¨ Security vulnerabilities detected in adesso CMS"
          echo "Please review the security report and take immediate action"
          echo "Critical issues must be resolved before deployment"

# ============================================================================
# WORKFLOW METADATA
# ============================================================================
# ğŸ›¡ï¸ Enterprise Security Pipeline for adesso CMS
# ğŸ”’ Comprehensive vulnerability scanning and compliance checks
# ğŸ‡©ğŸ‡ª German market compliance: "adesso wird immer klein geschrieben"
# ğŸ§¹ Code quality security analysis with Drupal best practices
# ğŸš€ Generated with Claude Code (https://claude.ai/code)
# 
# Co-Authored-By: Claude <noreply@anthropic.com>